{% extends 'base.html' %}
{% block content %}
<div class="card">
    <div style="display: flex; align-items: center; gap: 2rem;">
        {% if profile_user.profile.profile_picture %}
            <img src="{{ profile_user.profile.profile_picture.url }}" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
        {% else %}
            <div style="width: 100px; height: 100px; border-radius: 50%; background: var(--primary-color); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">
                {{ profile_user.username|slice:":1"|upper }}
            </div>
        {% endif %}
        <div>
            <h1>{{ profile_user.username }}</h1>
            <p>{{ profile_user.profile.bio }}</p>
            {% if profile_user.profile.university %}
                <p style="color: #94a3b8; font-size: 0.9rem;">ðŸŽ“ {{ profile_user.profile.university }}</p>
            {% endif %}
            
            <div style="margin-top: 1rem;">
                {% if request.user == profile_user %}
                    <a href="{% url 'profile-edit' %}" class="btn-link" style="color: var(--primary-color);">Edit Profile</a>
                {% else %}
                    {% if profile_user.profile.profile_type == 'friend' %}
                        {% if is_friend %}
                            <button class="btn-primary" disabled style="opacity: 0.7;">Friends</button>
                        {% elif friend_request_sent %}
                            <button class="btn-primary" disabled style="opacity: 0.7;">Request Sent</button>
                        {% else %}
                            <a href="{% url 'send-friend-request' profile_user.username %}" class="btn-primary">Add Friend</a>
                        {% endif %}
                    {% else %}
                        {% if is_following %}
                            <a href="{% url 'unfollow-user' profile_user.username %}" class="btn-primary" style="background: transparent; border: 1px solid var(--primary-color);">Unfollow</a>
                        {% else %}
                            <a href="{% url 'follow-user' profile_user.username %}" class="btn-primary">Follow</a>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if request.user == profile_user and friend_requests %}
    <div class="card">
        <h3>Friend Requests</h3>
        <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
            {% for req in friend_requests %}
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        {% if req.sender.profile.profile_picture %}
                            <img src="{{ req.sender.profile.profile_picture.url }}" class="avatar">
                        {% else %}
                            <div class="avatar">{{ req.sender.username|slice:":1"|upper }}</div>
                        {% endif %}
                        <a href="{% url 'profile' req.sender.username %}" class="post-user">{{ req.sender.username }}</a>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="{% url 'accept-friend-request' req.id %}" class="btn-primary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Accept</a>
                        <a href="{% url 'reject-friend-request' req.id %}" class="btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Reject</a>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endif %}

{% if friends %}
    <div class="card">
        <h3>Friends</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem;">
            {% for friend in friends %}
                <a href="{% url 'profile' friend.username %}" style="text-decoration: none; text-align: center;">
                    {% if friend.profile.profile_picture %}
                        <img src="{{ friend.profile.profile_picture.url }}" class="avatar" style="width: 50px; height: 50px; margin: 0 auto;">
                    {% else %}
                        <div class="avatar" style="width: 50px; height: 50px; margin: 0 auto;">{{ friend.username|slice:":1"|upper }}</div>
                    {% endif %}
                    <div class="post-user" style="font-size: 0.875rem; margin-top: 0.25rem;">{{ friend.username }}</div>
                </a>
            {% endfor %}
        </div>
    </div>
{% endif %}

<h2>Posts</h2>
{% for post in profile_user.posts.all %}
    <div class="card">
        <div class="post-header">
            {% if post.user.profile.profile_picture %}
                <img src="{{ post.user.profile.profile_picture.url }}" class="avatar">
            {% else %}
                <div class="avatar" style="background: var(--primary-color); display: flex; align-items: center; justify-content: center; color: white;">
                    {{ post.user.username|slice:":1"|upper }}
                </div>
            {% endif %}
            <div>
                <div><span class="post-user">{{ post.user.username }}</span></div>
                <div class="post-date">{{ post.created_at|date:"M d, Y" }}</div>
            </div>
        </div>
        <p style="margin-bottom: 1rem; line-height: 1.6;">{{ post.caption }}</p>
        {% if post.image %}
            <div class="post-image-container">
                <img src="{{ post.image.url }}" class="post-image">
            </div>
        {% endif %}
        <div style="margin-top: 1rem; color: #94a3b8; font-size: 0.875rem;">
            {{ post.total_likes }} Likes â€¢ {{ post.comments.count }} Comments
        </div>

        {% if post.total_likes > 0 %}
            <div style="font-size: 0.8rem; color: hsl(var(--muted-foreground)); margin-top: 0.5rem; padding-left: 0.5rem; border-left: 2px solid hsl(var(--border));">
                Liked by 
                {% for liker in post.likes.all|slice:":3" %}
                    <span style="color: hsl(var(--foreground));">{{ liker.username }}</span>{% if not forloop.last %}, {% endif %}
                {% endfor %}
                {% if post.total_likes > 3 %}
                    and {{ post.total_likes|add:"-3" }} others
                {% endif %}
            </div>
        {% endif %}
    </div>
{% empty %}
    <p>No posts yet.</p>
{% endfor %}
{% endblock %}
